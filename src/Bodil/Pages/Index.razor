@page "/"

@using BlazorScheduler
@using Bodil.Services;
@using Bodil.Models;
@using Bodil.States;
@using Microsoft.Identity.Web;

@inject IReservationService ReservationService
@inject IUserService UserService
@inject UserState UserState

<PageTitle>Index</PageTitle>
<AuthorizeView Context="userContext">
    <Authorized>
        <Scheduler OnAddingNewAppointment="OnAddingNewAppointment" OnRequestNewData="OnRequestNewData" TodayButtonText="I dag" EnableDragging=false>
            <Appointments>
                @foreach (var reservation in reservations)
                {
                    <Appointment Start="@reservation.Start" End="@reservation.End" Color="@user.Color">
                        @reservation.Title
                    </Appointment>
                }
            </Appointments>
        </Scheduler>
    </Authorized>
    <NotAuthorized>
        <MudText Typo="Typo.h2">Du er ikke logget inn</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {

    AppUser user = new();
    List<Reservation> reservations = new();

    protected override async Task OnInitializedAsync()
    {
        if (!UserState.IsLoggedIn)
            await UserService.LoginAsync();

        user = await UserService.GetUserAsync(UserState.UserId);
    }

    async Task OnAddingNewAppointment(DateTime start, DateTime end) => await ReservationService.AddReservation(user, start, end);

    async Task OnRequestNewData(DateTime start, DateTime end) => reservations = await ReservationService.GetReservationsAsync(start, end);
}
